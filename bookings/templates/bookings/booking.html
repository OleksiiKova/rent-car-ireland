{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container">
    <h1 class="text-center">Car Booking</h1>
    <div class="d-flex justify-content-center align-items-center search-form">
        <div class="col-md-6 mt-2">
            <form method="POST" action="{% url 'booking' %}">
                {% csrf_token %}
                <!-- Display form errors -->
                {% if form.errors %}
                <div class="alert alert-danger">
                    <ul>
                        {% for field in form %}
                        {% for error in field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                        <!-- {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %} -->
                    </ul>
                </div>
                {% endif %}
                <div class="form-row">
                    <div class="col-md-3">
                        <p>Pick up Office</p>
                        {{ form.pickup_office }}
                    </div>
                    <div class="col-md-3">
                        <p>Return Office</p>
                        {{ form.return_office }}
                    </div>
                </div>
                <p>Start time</p>
                <div class="form-row">
                    <div class="col-md-3">
                        {{ form.start_date }}
                    </div>
                    <div class="col-md-3">
                        {{ form.pick_up_time }}
                    </div>
                </div>
                <p>End time</p>
                <div class="form-row">
                    <div class="col-md-3">
                        {{ form.end_date }}
                    </div>
                    <div class="col-md-3">
                        {{ form.drop_off_time }}
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-secondary mx-2" type="submit">Search</button>
                </div>
            </form>
        </div>
    </div>
    {% if cars %}
    <div class="d-flex justify-content-end">
        <button class="filter-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterText"
            aria-controls="filterText" aria-expanded="false" aria-label="Toggle filter">
            <span><i class="fa-solid fa-filter"></i></span>
        </button>
    </div>
    <div class="filters-collapse mt-2 collapse d-lg-block" id="filterText">
        <div class="d-flex col-12 flex-wrap justify-content-center">
            <div class="mb-2">
                <label class="mx-2">
                    <input type="checkbox" id="air-conditioning" name="air_conditioning"> Air Conditioning
                </label>
                <label class="mx-2">
                    <input type="checkbox" id="navigation" name="navigation"> Navigation
                </label>
            </div>
            <div class="mb-2">
                <label for="car-type" class="mx-2">Car Type:</label>
                <select id="car-type" name="car_type" class="mx-2 mb-2">
                    <option value="all">All Types</option>
                    {% for car_type in car_types %}
                    <option value="{{ car_type }}">{{ car_type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label for="transmission" class="mx-2">Transmission:</label>
                <select id="transmission" name="transmission" class="mx-2">
                    <option value="all">All</option>
                    {% for transmission in transmissions %}
                    <option value="{{ transmission }}">{{ transmission }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label for="sort" class="mx-2">Sort by:</label>
                <select id="sort" class="mx-2">
                    <option value="default" selected>Default</option>
                    <option value="price_asc">Price per day ↑</option>
                    <option value="price_desc">Price per day ↓</option>
                </select>
            </div>
            <div class="">
                <button id="reset-filters" class="btn-small btn-secondary mx-2">Reset Filters</button>
            </div>
        </div>




    </div>


    <div id="car-list-container" class="col-12 mt-3">
        {% include 'bookings/car_list.html' %}
    </div>
    <!-- {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li><a href="?page={{ page_obj.previous_page_number }}" class="page-link"> PREV &laquo;</a></li>
            {% endif %}
            {% if page_obj.has_next %}
            <li><a href="?page={{ page_obj.next_page_number }}" class="page-link"> NEXT &raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %} -->

    {% endif %}


    <script>
        $(document).ready(function () {
            // Function to update temporary selections
            function updatePickupTimeChoices(officeId) {
                $.ajax({
                    url: "{% url 'update_pickup_time_choices' %}",
                    data: {
                        'office_id': officeId
                    },
                    success: function (data) {
                        var pickUpTimeSelect = $('#id_pick_up_time');
                        // var dropOffTimeSelect = $('#id_drop_off_time');
                        pickUpTimeSelect.empty();
                        // dropOffTimeSelect.empty();

                        // Enumeration of received temporary selections for Pick up time
                        $.each(data.choices, function (index, value) {
                            pickUpTimeSelect.append($('<option></option>').attr('value',
                                value[
                                    0]).text(value[1]));
                        });

                        // Iterate through the received temporary selections for Drop off time
                        // $.each(data.choices, function (index, value) {
                        //     dropOffTimeSelect.append($('<option></option>').attr('value',
                        //         value[
                        //             0]).text(value[1]));
                        // });

                        // Setting the default time to 09:00 for Pick up time
                        pickUpTimeSelect.val('09:00');

                        // Setting the default time to 09:00 for Drop off time
                        // dropOffTimeSelect.val('09:00');
                    }
                });
            }

            // Initializing temporary selections on page load
            // updatePickupTimeChoices($('#id_pickup_office').val());

            // Office selection change handler
            $('#id_pickup_office').change(function () {
                updatePickupTimeChoices($(this).val());
            });

            // Removing an empty line from office lists
            $('#id_pickup_office option:first').remove();
            $('#id_return_office option:first').remove();
        });
    </script>
    <script src="{% static 'js/booking_form.js' %}"></script>
    <script src="{% static 'js/update_car_list.js' %}"></script>
    {% endblock %}