{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center">Car Search</h2>
    <div class="d-flex justify-content-center align-items-center search-form my-4">
        <div class="col-12 col-lg-8 mt-2">
            <form method="POST" action="{% url 'booking' %}">
                {% csrf_token %}
                <!-- Display form errors -->
                {% if form.errors %}
                <div class="alert alert-danger">
                    <ul>
                        {% for field in form %}
                        {% for error in field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                        <!-- {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %} -->
                    </ul>
                </div>
                {% endif %}
                <div class="form-row">
                    <div class="col-md-3">
                        <p>Pick up Office</p>
                        {{ form.pickup_office }}
                    </div>
                    <div class="col-md-3 p-0">
                        <p>Return Office</p>
                        {{ form.return_office }}
                    </div>
                </div>
                <p>Start time</p>
                <div class="form-row">
                    <div class="col-md-3">
                        {{ form.start_date }}
                    </div>
                    <div class="col-md-3 p-0">
                        {{ form.pick_up_time }}
                    </div>
                </div>
                <p>End time</p>
                <div class="form-row">
                    <div class="col-md-3">
                        {{ form.end_date }}
                    </div>
                    <div class="col-md-3 p-0">
                        {{ form.drop_off_time }}
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-primary m-2" type="submit">Search</button>
                </div>
            </form>
        </div>
    </div>
    {% if cars %}
    <div class="row flex justify-content-center">
        <div class="d-flex justify-content-end col-lg-8">
            <button class="filter-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#filterText"
                aria-controls="filterText" aria-expanded="false" aria-label="Toggle filter">
                <span><i class="bi bi-funnel-fill"></i></span>
            </button>
        </div>
        <div class="filters-collapse mt-2 collapse justify-content-center " id="filterText">
            <div class="d-flex justify-content-center">
                <div class="d-flex col-lg-8 flex-wrap justify-content-center">
                    <div class="mb-2">
                        <label class="mx-2">
                            <input type="checkbox" id="air-conditioning" name="air_conditioning"> Air Conditioning
                        </label>
                        <label class="mx-2">
                            <input type="checkbox" id="navigation" name="navigation"> Navigation
                        </label>
                    </div>
                    <div class="mb-2">
                        <label for="car-type" class="mx-2">Car Type:</label>
                        <select id="car-type" name="car_type" class="mx-2 mb-2">
                            <option value="all">All Types</option>
                            {% for car_type in car_types %}
                            <option value="{{ car_type }}">{{ car_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="transmission" class="mx-2">Transmission:</label>
                        <select id="transmission" name="transmission" class="mx-2">
                            <option value="all">All</option>
                            {% for transmission in transmissions %}
                            <option value="{{ transmission }}">{{ transmission }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="sort" class="mx-2">Sort by:</label>
                        <select id="sort" class="mx-2">
                            <option value="default" selected>Default</option>
                            <option value="price_asc">Price per day ↑</option>
                            <option value="price_desc">Price per day ↓</option>
                        </select>
                    </div>
                    <div class="">
                        <button id="reset-filters" class="btn-small btn-secondary mx-2">Reset Filters</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="car-list-container" class="col-12 mt-3">
        {% include 'bookings/car_list.html' %}
    </div>
    {% endif %}
</div>

<script>
    /**
    * Handles updating the car list based on selected filters and user authentication status.
    * 
    * This script initializes car list updates based on user selections from various filters (car type, transmission, etc.)
    * and updates the displayed list of cars through an AJAX request. It also manages the visibility of reserve buttons
    * and login prompts based on the user's authentication status.
    * 
    * - Filters include car type, transmission, air conditioning, navigation, start and end dates, pickup and drop-off times, and offices.
    * - When filters change or the reset button is clicked, it triggers an AJAX request to update the car list.
    * - On successful data retrieval, it updates the car list and adjusts UI elements based on authentication status.
    */
    $(document).ready(function () {
        var sortBy = 'default';
        var isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

        function updateCarList() {
            var carType = $('#car-type').val();
            var transmission = $('#transmission').val();
            var airConditioning = $('#air-conditioning').prop('checked');
            var navigation = $('#navigation').prop('checked');
            var startDate = $('#id_start_date').val();
            var endDate = $('#id_end_date').val();
            var pickUpTime = $('#id_pick_up_time').val();
            var dropOffTime = $('#id_drop_off_time').val();
            var pickupOffice = $('#id_pickup_office').val();
            var returnOffice = $('#id_return_office').val();

            $.ajax({
                url: '/update_car_list/',
                data: {
                    'car_type': carType,
                    'transmission': transmission,
                    'sort_by': sortBy,
                    'air_conditioning': airConditioning,
                    'navigation': navigation,
                    'start_date': startDate,
                    'end_date': endDate,
                    'pick_up_time': pickUpTime,
                    'drop_off_time': dropOffTime,
                    'pickup_office': pickupOffice,
                    'return_office': returnOffice,
                    // 'is_authenticated': isAuthenticated
                },
                dataType: 'json',
                success: function (data) {
                    $('#car-list-container').html(data.html);

                    // Ensure that the buttons are updated based on authentication status
                    if (data.is_authenticated) {
                        $('.reserve-button').show();
                        $('.login-to-continue').hide();
                    } else {
                        $('.reserve-button').hide();
                        $('.login-to-continue').show();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading data:', error);
                }
            });
        }

        // Filter change handlers
        $('#car-type, #transmission, #sort, #air-conditioning, #navigation').change(function () {
            if ($(this).attr('id') === 'sort') {
                sortBy = $(this).val();
                updateCarList();
            } else {
                updateCarList();
            }
        });

        // Reset button handler
        $('#reset-filters').click(function () {
            $('#car-type').val('all');
            $('#transmission').val('all');
            $('#air-conditioning, #navigation').prop('checked', false);
            sortBy = 'default';
            updateCarList();
        });

        updateCarList();
    });
    $(document).ready(function () {
        // Function to update temporary selections
        function updatePickupTimeChoices(officeId) {
            $.ajax({
                url: "{% url 'update_pickup_time_choices' %}",
                data: {
                    'office_id': officeId
                },
                success: function (data) {
                    var pickUpTimeSelect = $('#id_pick_up_time');
                    pickUpTimeSelect.empty();

                    // Enumeration of received temporary selections for Pick up time
                    $.each(data.choices, function (index, value) {
                        pickUpTimeSelect.append($('<option></option>').attr('value',
                            value[
                                0]).text(value[1]));
                    });
                    pickUpTimeSelect.val('09:00');
                }
            });
        }

        // Office selection change handler
        $('#id_pickup_office').change(function () {
            updatePickupTimeChoices($(this).val());
        });

        // Removing an empty line from office lists
        $('#id_pickup_office option:first').remove();
        $('#id_return_office option:first').remove();
    });

    /**
    * Updates the end date input field based on the selected start date.
    * 
    * This script sets the minimum allowable date for the end date input to the selected start date.
    * If the current end date is earlier than the start date, it clears the end date input.
    */

    document.addEventListener('DOMContentLoaded', function () {
        var startDateInput = document.getElementById('id_start_date');
        var endDateInput = document.getElementById('id_end_date');
    
        // When start_date changes
        startDateInput.addEventListener('change', function () {
            var startDate = new Date(startDateInput.value);
            // Set the minimum value end_date
            endDateInput.min = startDateInput.value;
            // If end_date is earlier than start_date, reset its value
            if (new Date(endDateInput.value) < startDate) {
                endDateInput.value = '';
            }
        });
    });
</script>
{% endblock %}